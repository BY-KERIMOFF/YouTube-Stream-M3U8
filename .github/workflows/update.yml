name: Update TR YouTube Streams

on:
  schedule:
    # Hər 30 dəqiqədə bir yenilə
    - cron: '*/30 * * * *'
  
  workflow_dispatch:
  
  push:
    branches: [ main ]
    paths:
      - '**.json'
      - '**.py'
      - '.github/workflows/**.yml'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yt-dlp
          pip install requests
      
      - name: Update streams
        id: update-streams
        run: |
          echo "Starting TR YouTube Stream Updater..."
          python main.py
          
          # Check result
          m3u8_count=$(find TR -name "*.m3u8" 2>/dev/null | wc -l || echo "0")
          echo "m3u8_count=$m3u8_count" >> $GITHUB_OUTPUT
          
          if [ $m3u8_count -gt 0 ]; then
            echo "Found $m3u8_count streams"
            echo "has_streams=true" >> $GITHUB_OUTPUT
          else
            echo "No streams found"
            echo "has_streams=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for changes
        if: steps.update-streams.outputs.has_streams == 'true'
        id: check-changes
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          
          git add TR/ 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            echo "New changes detected"
            echo "changes=true" >> $GITHUB_OUTPUT
            
            # Show changed files
            echo "Changed files:"
            git diff --cached --name-only
          else
            echo "No new changes"
            echo "changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit changes
        if: steps.update-streams.outputs.has_streams == 'true' && steps.check-changes.outputs.changes == 'true'
        run: |
          git commit -m "Update TR streams (${{ steps.update-streams.outputs.m3u8_count }} streams) - $(date +'%Y-%m-%d %H:%M')"
      
      - name: Push changes
        if: steps.update-streams.outputs.has_streams == 'true' && steps.check-changes.outputs.changes == 'true'
        run: |
          git push
      
      - name: Show result
        run: |
          echo "========================================"
          echo "TR YouTube Stream Updater Completed"
          echo "========================================"
          echo "Date: $(date)"
          echo "Stream count: ${{ steps.update-streams.outputs.m3u8_count }}"
          echo "Changes: ${{ steps.check-changes.outputs.changes }}"
          echo "Status: ${{ job.status }}"
          echo "========================================"
